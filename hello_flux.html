<!DOCTYPE html>
<html>
  <head>
    <title>Hello Flux</title>
    <script src="https://fb.me/react-0.13.2.js"></script>
    <script src="https://fb.me/JSXTransformer-0.13.2.js"></script>

		<style>
		.light {
			display: inline-block;
			height: 50px;
			width: 50px;
			background-color: #ffc;
		}

		.light-up {
			background-color: red;
		}

		</style>
  </head>
  <body>
    <div id="bar"></div>

    <script type="text/jsx;harmony=true">

    const TICK = 'TICK';
    const START = 'START';

    //
    // Dispatcher
    //
    class Dispatcher {
    	constructor () {
    		this.callbacks = [];
    	}

    	register ( cb ) {
    		this.callbacks.push( cb );
    	}

    	dispatch ( msg ) {
    		this.callbacks.each( cb => { cb( msg ); } );
    	}

    	// action helper
    	send ( type, data ) {
    		this.dispatch( {type: type, data: data} );
    	}
    }

    var dispatchio = new Dispatcher();



    //
    // Store
    //
    class Sequence {
    	constructor ( dispatcher ) {
    		dispatcher.register( this.delegater );
    	}

    	delegater ( message ) {
    		switch ( message.type ) {
    			case START:
    				console.log( 'delegate START' );
    				break;
  				case TICK:
    				console.log( 'delegate TICK' );
  					break;
    		}
    	}
    }

    var seq = new Sequence( dispatchio );



    //
    // Components
    //
    var LightBar = React.createClass({
    	getInitialState: function getInitialLightBarState () {
    		return { current: 0 };
    	},

    	bump: function () {
    		var newCurrent =  (this.state.current + 1) % 4;
    		console.log( newCurrent );
    		this.setState( {current: newCurrent} );
    	},

		  componentDidMount: function () {
		    setInterval(this.bump, this.props.interval);
		  },

    	render: function renderLightBar () {
    		var current = this.state.current;
    		var lights = [0, 1, 2, 3].map( index => <Light lit={ index === current } /> );
    		return <span>{lights}</span>;
    	}
    });

    var Light = React.createClass({
    	render: function renderLight () {
    		var lightUp = this.props.lit? ' light-up': '';
    		return <span className={'light' + lightUp} />
    	}
    });

		// Go!
		React.render( <LightBar interval={750} />, document.getElementById( 'bar' ) );



    </script>
  </body>
</html>